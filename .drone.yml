kind: pipeline
type: docker
name: build-rainbond-allinone

platform:
  os: linux
  arch: arm64

trigger:
  event:
    include:
    - custom

node:
  city: sydney

environment:
  GOOS: linux
  VERSION: enterprise-2306-arm
  IMAGE_DOMAIN: image.goodrain.com
  IMAGE_NAMESPACE: goodrain
  DOCKER_USERNAME: root
  DOCKER_PASSWORD: goodrain123465!
  ALLINONE: true
  
steps:
- name: clone rainbond-ui-cloud
  image: alpine/git
  commands:
  - git clone -b enterprise-2306 --depth=1 https://pull-code:gr123465!!@git.goodrain.com/goodrain/rainbond-ui-cloud.git
  - git clone -b enterprise-2306 --depth=1 https://pull-code:gr123465!!@git.goodrain.com/goodrain/rainbond-console-cloud.git

- name: build rainbond-ui-cloud dist
  image: node:14
  commands:
  - cd rainbond-ui-cloud
  - yarn config set registry https://registry.npm.taobao.org
  - yarn install
  - yarn run build

- name: build rainbond-ui-cloud
  image: rainbond/docker:dind
  privileged: true
  volumes:
  - name: dockersock
    path: /var/run
  commands:
  - sleep 10 # give docker enough time to start
  - cd rainbond-ui-cloud
  - docker build -t ${IMAGE_DOMAIN}/${IMAGE_NAMESPACE}/rainbond-ui:$VERSION .

- name: build rainbond-console
  image: rainbond/docker:dind
  privileged: true
  volumes:
  - name: dockersock
    path: /var/run
  commands:
  - rm -rf rainbond-ui
  - cd rainbond-console-cloud
  - BUILD_ARCH=arm64 ./release.sh allinone
  when:
    event:
      include:
      - custom

services:
- name: docker
  image: docker:dind
  privileged: true
  volumes:
  - name: dockersock
    path: /var/run

volumes:
- name: dockersock
  temp: {}
